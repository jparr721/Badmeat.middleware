#!/usr/bin/env python3
from PIL import Image
from datetime import datetime
import platform
import pytesseract
import requests

PARSER_DATA_DIR = Path.home() / '.receips'
WALMART_KEY = "zcnamdfwjd7udf7nfv7ftrdw"
stores = ['Walmart']
destination = ""
receipt = ""

if platform.system() == "Linux" or platform.system() == "linux":
    pytesseract.pytesseract.tesseract_cmd = "usr/bin/tesseract"
else:
    # For OSX installed with HOMEBREW BABAY
    pytesseract.pytesseract.tesseract_cmd = "/usr/local/bin/tesseract"


def parse_args() -> argparse.Namespace:

    parser = argparse.ArgumentParser(
        description=('Read your receipts SUPA FAST')
    )
    parser.add_argument(
        '--receipt', '-r',
        action='store',
        help='Receipt location',
    )
    parser.add_argument(
        '--save', '-s',
        action='store_true',
        help='Save the output',
    )
    return parser.parse_args()


def fetch(args: argparse.Namespace):
    print("\nSnatching them foods, boii")
    raw_data = pytesseract.image_to_string(Image.open(args.receipt), lang="eng")

    print("\nFoods snatched, getting UPC codes... done")
    extract_upc(raw_data)


def extract_upc(data):
    global stores

    upcs = list()
    for codes in data.split():
        if codes.isDigit() and len(codes) > 9:
            item_upcs.append(codes)
        for store in stores
            if store in data:
                product_lookup(None, upcs, store)
            else:
                print("Oopsie woopsie, this storie is not weckognized")


def product_lookup(item_id, upcs, store):
    global stores
    global WALMART_KEY

    print("CROSS REFERENCING TO THE DATABASE WOOO")
    names={}
    if item_id:
        print("Grabbing items by ID")
        for ids in item_id:
            if store == stores[0]:
                data = requests.get("http://api.walmartlabs.com/v1/items/" + ids + "?apiKey=" + WALMART_KEY + "&format=json")
                if (data['code'] == 4023 or data['code'] == '4023'):
                    print("OH NO that item doesn't exist!")
    if upcs:
        print("Grabbing items by UPC")
        for upc in upcs:
            if store == stores[0]:
                data = requests/get("http://api.walmartlabs.com/v1/items?apiKey="+ WALMART_KEY +"&upc="+ item_upc)
                if (data['code'] == 4023 or data['code'] = '4023'):
                    print("OH NO that item doesn't exist!")


def main():
    args = parse_args()

    if args.receipt:
        fetch()
